<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Page Counter and Chat Room</title>
    <style>
        /* ... [Your Existing Styles] ... */
    </style>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>
</head>

<body>
    <div id="chat-container">
        <div id="messages">
            <!-- Chat messages will appear here -->
        </div>
        <div id="input-container">
            <input type="text" id="username" placeholder="Username" />
            <input type="text" id="message-input" placeholder="Message" />
            <input type="file" id="image-input" accept="image/*" onchange="previewImage()" />
            <img id="image-preview" style="max-width: 200px; display: none; margin-top: 10px;" />
            <button onclick="sendMessage()">Send</button>
        </div>
    </div>

    <div style="text-align: center; margin-top: 20px;">
        You are visitor number:
        <span id="counter">Loading...</span>
    </div>

    <script>
        const firebaseConfig = {
            /* ... [Your Existing Firebase Configuration] ... */
        };

        try {
            firebase.initializeApp(firebaseConfig);
        } catch (error) {
            console.error("Firebase initialization failed:", error);
        }

        const db = firebase.firestore();
        const storage = firebase.storage();

        const pageviewsDoc = db.collection('metadata').doc('pageviews');
        const messagesDiv = document.getElementById('messages');
        const usernameInput = document.getElementById('username');
        const messageInput = document.getElementById('message-input');

        pageviewsDoc.get().then(doc => {
            /* ... [Your Existing Pageviews Code] ... */
        }).catch(error => {
            console.error("Error fetching pageviews data:", error);
        });

        function sendMessage() {
            const username = usernameInput.value.trim();
            const messageText = messageInput.value.trim();
            const imageInput = document.getElementById('image-input');
            
            if (username && (messageText || imageInput.files.length)) {
                if (imageInput.files.length > 0) {
                    const imageFile = imageInput.files[0];
                    const storageRef = storage.ref(`chat-images/${Date.now()}_${imageFile.name}`);
                    storageRef.put(imageFile).then(snapshot => {
                        return snapshot.ref.getDownloadURL();
                    }).then(url => {
                        addMessageToFirestore(url);
                    });
                } else {
                    addMessageToFirestore();
                }
            }

            function addMessageToFirestore(imageUrl = '') {
                db.collection('chat').add({
                    username: username,
                    message: messageText,
                    imageUrl: imageUrl,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                }).then(() => {
                    messageInput.value = '';
                    imageInput.value = '';
                    document.getElementById('image-preview').style.display = 'none';
                    messagesDiv.scrollTop = messagesDiv.scrollHeight;
                });
            }
        }

        function previewImage() {
            const imageInput = document.getElementById('image-input');
            const imagePreview = document.getElementById('image-preview');

            if (imageInput.files && imageInput.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    imagePreview.src = e.target.result;
                    imagePreview.style.display = 'block';
                }
                reader.readAsDataURL(imageInput.files[0]);
            }
        }

        db.collection('chat').orderBy('timestamp', 'desc').limit(200).onSnapshot(snapshot => {
            let messages = [];
            snapshot.forEach(doc => {
                const data = doc.data();
                let messageHtml = `<p><strong>${data.username}:</strong> ${data.message}</p>`;
                if (data.imageUrl) {
                    messageHtml += `<img src="${data.imageUrl}" style="max-width: 200px; margin-top: 10px;" />`;
                }
                messages.push(messageHtml);
            });
            messagesDiv.innerHTML = messages.reverse().join('');
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        });
    </script>
</body>
</html>







